/**
 * @license
 * Copyright Andrey Chalkin <L2jLiga@gmail.com> (https://github.com/L2jLiga). All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://github.com/L2jLiga/fastify-decorators/blob/master/LICENSE
 */
import { CREATOR, SERVICE_INJECTION } from '../../symbols/index.js';
import { hasServiceInjection } from './class-properties.js';
import { defaultScope, dependencyScopeManager } from './dependency-scope.js';
export function classLoaderFactory(injectables) {
    function classLoader(constructor, scope) {
        scope = scope || defaultScope;
        if (dependencyScopeManager.has(scope, constructor))
            return dependencyScopeManager.get(scope, constructor);
        /**
         * Step 1: Patch constructor and prototype with Injectables (issue #752)
         */
        injectProperties(constructor, constructor, injectables, classLoader, constructor.name);
        injectProperties(constructor.prototype, constructor.prototype, injectables, classLoader, constructor.name);
        /**
         * Step 2: Create instance
         */
        const instance = typeof Reflect.getMetadata === 'function' ? new constructor(...getArguments(constructor, injectables, classLoader, constructor.name)) : new constructor();
        /**
         * Step 3: Inject dependencies into instance (issue #750)
         */
        injectProperties(instance, constructor.prototype, injectables, classLoader, constructor.name);
        /**
         * Step 4: Optionally store instance in Map if cache enabled
         */
        dependencyScopeManager.add(scope, constructor, instance);
        /**
         * Step 4: Return instance with dependencies injected
         */
        return instance;
    }
    return Object.assign(classLoader, {
        reset(scope) {
            dependencyScopeManager.clear(scope);
        },
    });
}
function injectProperties(target, source, injectables, classLoader, className) {
    if (!hasServiceInjection(source))
        return;
    const viaInject = source[SERVICE_INJECTION];
    for (const { name, propertyKey } of viaInject) {
        if (!injectables.has(name))
            throw new TypeError(`Invalid argument provided for "${className}.${String(propertyKey)}". Expected class annotated with @Service.`);
        Object.defineProperty(target, propertyKey, {
            // @ts-expect-error we already have checked that injectables list has this entry, no needs to nullish coalescing and so on
            value: injectables.get(name)[CREATOR].register(classLoader),
            enumerable: true,
            configurable: true,
        });
    }
}
function getArguments(constructor, injectables, classLoader, className) {
    const metadata = Reflect.getMetadata('design:paramtypes', constructor) || [];
    return metadata
        .map((value) => injectables.get(value))
        .map((value) => {
        if (value)
            return value[CREATOR].register(classLoader);
        throw new TypeError(`Invalid argument provided in ${className}'s constructor. Expected class annotated with @Service.`);
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5qZWN0LWRlcGVuZGVuY2llcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2xpYi9kZWNvcmF0b3JzL2hlbHBlcnMvaW5qZWN0LWRlcGVuZGVuY2llcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFLSCxPQUFPLEVBQUUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDcEUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDNUQsT0FBTyxFQUFFLFlBQVksRUFBbUIsc0JBQXNCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQWM5RixNQUFNLFVBQVUsa0JBQWtCLENBQUMsV0FBK0I7SUFDaEUsU0FBUyxXQUFXLENBQUksV0FBMkIsRUFBRSxLQUF1QjtRQUMxRSxLQUFLLEdBQUcsS0FBSyxJQUFJLFlBQVksQ0FBQztRQUU5QixJQUFJLHNCQUFzQixDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDO1lBQUUsT0FBTyxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBTSxDQUFDO1FBRS9HOztXQUVHO1FBQ0gsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2RixnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxTQUFTLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFM0c7O1dBRUc7UUFDSCxNQUFNLFFBQVEsR0FDWixPQUFPLE9BQU8sQ0FBQyxXQUFXLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxHQUFHLFlBQVksQ0FBQyxXQUFXLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUU1Sjs7V0FFRztRQUNILGdCQUFnQixDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsU0FBUyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTlGOztXQUVHO1FBQ0gsc0JBQXNCLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFekQ7O1dBRUc7UUFDSCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRUQsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRTtRQUNoQyxLQUFLLENBQUMsS0FBc0I7WUFDMUIsc0JBQXNCLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RDLENBQUM7S0FDRixDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxNQUFlLEVBQUUsTUFBZSxFQUFFLFdBQStCLEVBQUUsV0FBd0IsRUFBRSxTQUFpQjtJQUN0SSxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDO1FBQUUsT0FBTztJQUN6QyxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUM1QyxLQUFLLE1BQU0sRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLElBQUksU0FBUyxFQUFFO1FBQzdDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQztZQUN4QixNQUFNLElBQUksU0FBUyxDQUFDLGtDQUFrQyxTQUFTLElBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO1FBRXRJLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLFdBQVcsRUFBRTtZQUN6QywwSEFBMEg7WUFDMUgsS0FBSyxFQUFFLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQztZQUMzRCxVQUFVLEVBQUUsSUFBSTtZQUNoQixZQUFZLEVBQUUsSUFBSTtTQUNuQixDQUFDLENBQUM7S0FDSjtBQUNILENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBSSxXQUEyQixFQUFFLFdBQStCLEVBQUUsV0FBd0IsRUFBRSxTQUFpQjtJQUNoSSxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLG1CQUFtQixFQUFFLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUM3RSxPQUFPLFFBQVE7U0FDWixHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDdEMsR0FBRyxDQUFDLENBQUMsS0FBb0MsRUFBRSxFQUFFO1FBQzVDLElBQUksS0FBSztZQUFFLE9BQU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN2RCxNQUFNLElBQUksU0FBUyxDQUFDLGdDQUFnQyxTQUFTLHlEQUF5RCxDQUFDLENBQUM7SUFDMUgsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEFuZHJleSBDaGFsa2luIDxMMmpMaWdhQGdtYWlsLmNvbT4gKGh0dHBzOi8vZ2l0aHViLmNvbS9MMmpMaWdhKS4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2dpdGh1Yi5jb20vTDJqTGlnYS9mYXN0aWZ5LWRlY29yYXRvcnMvYmxvYi9tYXN0ZXIvTElDRU5TRVxuICovXG5cbmltcG9ydCB7IENsYXNzTG9hZGVyIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9ib290c3RyYXAtY29uZmlnLmpzJztcbmltcG9ydCB7IEluamVjdGFibGVTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9pbmplY3RhYmxlLWNsYXNzLmpzJztcbmltcG9ydCB7IF9JbmplY3RhYmxlc0hvbGRlciB9IGZyb20gJy4uLy4uL3JlZ2lzdHJ5L19pbmplY3RhYmxlcy1ob2xkZXIuanMnO1xuaW1wb3J0IHsgQ1JFQVRPUiwgU0VSVklDRV9JTkpFQ1RJT04gfSBmcm9tICcuLi8uLi9zeW1ib2xzL2luZGV4LmpzJztcbmltcG9ydCB7IGhhc1NlcnZpY2VJbmplY3Rpb24gfSBmcm9tICcuL2NsYXNzLXByb3BlcnRpZXMuanMnO1xuaW1wb3J0IHsgZGVmYXVsdFNjb3BlLCBEZXBlbmRlbmN5U2NvcGUsIGRlcGVuZGVuY3lTY29wZU1hbmFnZXIgfSBmcm9tICcuL2RlcGVuZGVuY3ktc2NvcGUuanMnO1xuXG5leHBvcnQgdHlwZSBDb25zdHJ1Y3RvcjxUPiA9IHsgbmV3ICgpOiBUIH0gfCB7IG5ldyAoLi4uYXJnczogYW55KTogVCB9O1xuXG5leHBvcnQgaW50ZXJmYWNlIFNlcnZpY2VJbmplY3Rpb24ge1xuICBuYW1lOiBzdHJpbmcgfCBzeW1ib2wgfCB1bmtub3duO1xuICBwcm9wZXJ0eUtleTogc3RyaW5nIHwgc3ltYm9sO1xufVxuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5hbWVzcGFjZVxuZGVjbGFyZSBuYW1lc3BhY2UgUmVmbGVjdCB7XG4gIGZ1bmN0aW9uIGdldE1ldGFkYXRhKG1ldGFkYXRhS2V5OiAnZGVzaWduOnBhcmFtdHlwZXMnLCB0YXJnZXQ6IHVua25vd24pOiBTZXJ2aWNlSW5qZWN0aW9uWyduYW1lJ11bXSB8IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsYXNzTG9hZGVyRmFjdG9yeShpbmplY3RhYmxlczogX0luamVjdGFibGVzSG9sZGVyKTogQ2xhc3NMb2FkZXIge1xuICBmdW5jdGlvbiBjbGFzc0xvYWRlcjxDPihjb25zdHJ1Y3RvcjogQ29uc3RydWN0b3I8Qz4sIHNjb3BlPzogRGVwZW5kZW5jeVNjb3BlKTogQyB7XG4gICAgc2NvcGUgPSBzY29wZSB8fCBkZWZhdWx0U2NvcGU7XG5cbiAgICBpZiAoZGVwZW5kZW5jeVNjb3BlTWFuYWdlci5oYXMoc2NvcGUsIGNvbnN0cnVjdG9yKSkgcmV0dXJuIGRlcGVuZGVuY3lTY29wZU1hbmFnZXIuZ2V0KHNjb3BlLCBjb25zdHJ1Y3RvcikgYXMgQztcblxuICAgIC8qKlxuICAgICAqIFN0ZXAgMTogUGF0Y2ggY29uc3RydWN0b3IgYW5kIHByb3RvdHlwZSB3aXRoIEluamVjdGFibGVzIChpc3N1ZSAjNzUyKVxuICAgICAqL1xuICAgIGluamVjdFByb3BlcnRpZXMoY29uc3RydWN0b3IsIGNvbnN0cnVjdG9yLCBpbmplY3RhYmxlcywgY2xhc3NMb2FkZXIsIGNvbnN0cnVjdG9yLm5hbWUpO1xuICAgIGluamVjdFByb3BlcnRpZXMoY29uc3RydWN0b3IucHJvdG90eXBlLCBjb25zdHJ1Y3Rvci5wcm90b3R5cGUsIGluamVjdGFibGVzLCBjbGFzc0xvYWRlciwgY29uc3RydWN0b3IubmFtZSk7XG5cbiAgICAvKipcbiAgICAgKiBTdGVwIDI6IENyZWF0ZSBpbnN0YW5jZVxuICAgICAqL1xuICAgIGNvbnN0IGluc3RhbmNlID1cbiAgICAgIHR5cGVvZiBSZWZsZWN0LmdldE1ldGFkYXRhID09PSAnZnVuY3Rpb24nID8gbmV3IGNvbnN0cnVjdG9yKC4uLmdldEFyZ3VtZW50cyhjb25zdHJ1Y3RvciwgaW5qZWN0YWJsZXMsIGNsYXNzTG9hZGVyLCBjb25zdHJ1Y3Rvci5uYW1lKSkgOiBuZXcgY29uc3RydWN0b3IoKTtcblxuICAgIC8qKlxuICAgICAqIFN0ZXAgMzogSW5qZWN0IGRlcGVuZGVuY2llcyBpbnRvIGluc3RhbmNlIChpc3N1ZSAjNzUwKVxuICAgICAqL1xuICAgIGluamVjdFByb3BlcnRpZXMoaW5zdGFuY2UsIGNvbnN0cnVjdG9yLnByb3RvdHlwZSwgaW5qZWN0YWJsZXMsIGNsYXNzTG9hZGVyLCBjb25zdHJ1Y3Rvci5uYW1lKTtcblxuICAgIC8qKlxuICAgICAqIFN0ZXAgNDogT3B0aW9uYWxseSBzdG9yZSBpbnN0YW5jZSBpbiBNYXAgaWYgY2FjaGUgZW5hYmxlZFxuICAgICAqL1xuICAgIGRlcGVuZGVuY3lTY29wZU1hbmFnZXIuYWRkKHNjb3BlLCBjb25zdHJ1Y3RvciwgaW5zdGFuY2UpO1xuXG4gICAgLyoqXG4gICAgICogU3RlcCA0OiBSZXR1cm4gaW5zdGFuY2Ugd2l0aCBkZXBlbmRlbmNpZXMgaW5qZWN0ZWRcbiAgICAgKi9cbiAgICByZXR1cm4gaW5zdGFuY2U7XG4gIH1cblxuICByZXR1cm4gT2JqZWN0LmFzc2lnbihjbGFzc0xvYWRlciwge1xuICAgIHJlc2V0KHNjb3BlOiBEZXBlbmRlbmN5U2NvcGUpIHtcbiAgICAgIGRlcGVuZGVuY3lTY29wZU1hbmFnZXIuY2xlYXIoc2NvcGUpO1xuICAgIH0sXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBpbmplY3RQcm9wZXJ0aWVzKHRhcmdldDogdW5rbm93biwgc291cmNlOiB1bmtub3duLCBpbmplY3RhYmxlczogX0luamVjdGFibGVzSG9sZGVyLCBjbGFzc0xvYWRlcjogQ2xhc3NMb2FkZXIsIGNsYXNzTmFtZTogc3RyaW5nKSB7XG4gIGlmICghaGFzU2VydmljZUluamVjdGlvbihzb3VyY2UpKSByZXR1cm47XG4gIGNvbnN0IHZpYUluamVjdCA9IHNvdXJjZVtTRVJWSUNFX0lOSkVDVElPTl07XG4gIGZvciAoY29uc3QgeyBuYW1lLCBwcm9wZXJ0eUtleSB9IG9mIHZpYUluamVjdCkge1xuICAgIGlmICghaW5qZWN0YWJsZXMuaGFzKG5hbWUpKVxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgSW52YWxpZCBhcmd1bWVudCBwcm92aWRlZCBmb3IgXCIke2NsYXNzTmFtZX0uJHtTdHJpbmcocHJvcGVydHlLZXkpfVwiLiBFeHBlY3RlZCBjbGFzcyBhbm5vdGF0ZWQgd2l0aCBAU2VydmljZS5gKTtcblxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIHByb3BlcnR5S2V5LCB7XG4gICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHdlIGFscmVhZHkgaGF2ZSBjaGVja2VkIHRoYXQgaW5qZWN0YWJsZXMgbGlzdCBoYXMgdGhpcyBlbnRyeSwgbm8gbmVlZHMgdG8gbnVsbGlzaCBjb2FsZXNjaW5nIGFuZCBzbyBvblxuICAgICAgdmFsdWU6IGluamVjdGFibGVzLmdldChuYW1lKVtDUkVBVE9SXS5yZWdpc3RlcihjbGFzc0xvYWRlciksXG4gICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldEFyZ3VtZW50czxDPihjb25zdHJ1Y3RvcjogQ29uc3RydWN0b3I8Qz4sIGluamVjdGFibGVzOiBfSW5qZWN0YWJsZXNIb2xkZXIsIGNsYXNzTG9hZGVyOiBDbGFzc0xvYWRlciwgY2xhc3NOYW1lOiBzdHJpbmcpIHtcbiAgY29uc3QgbWV0YWRhdGEgPSBSZWZsZWN0LmdldE1ldGFkYXRhKCdkZXNpZ246cGFyYW10eXBlcycsIGNvbnN0cnVjdG9yKSB8fCBbXTtcbiAgcmV0dXJuIG1ldGFkYXRhXG4gICAgLm1hcCgodmFsdWUpID0+IGluamVjdGFibGVzLmdldCh2YWx1ZSkpXG4gICAgLm1hcCgodmFsdWU6IEluamVjdGFibGVTZXJ2aWNlIHwgdW5kZWZpbmVkKSA9PiB7XG4gICAgICBpZiAodmFsdWUpIHJldHVybiB2YWx1ZVtDUkVBVE9SXS5yZWdpc3RlcihjbGFzc0xvYWRlcik7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBJbnZhbGlkIGFyZ3VtZW50IHByb3ZpZGVkIGluICR7Y2xhc3NOYW1lfSdzIGNvbnN0cnVjdG9yLiBFeHBlY3RlZCBjbGFzcyBhbm5vdGF0ZWQgd2l0aCBAU2VydmljZS5gKTtcbiAgICB9KTtcbn1cbiJdfQ==