'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var _injectablesHolder = require('../registry/_injectables-holder.cjs');
var destructors = require('../registry/destructors.cjs');
var index = require('../symbols/index.cjs');
var deferred = require('../utils/deferred.cjs');
var initializer = require('./initializer.cjs');

/**
 * @license
 * Copyright Andrey Chalkin <L2jLiga@gmail.com> (https://github.com/L2jLiga). All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://github.com/L2jLiga/fastify-decorators/blob/master/LICENSE
 */
function Service(injectableToken) {
    return (target) => {
        target[index.CREATOR] = {
            register(classLoader) {
                var _a;
                const instance = classLoader(target);
                if (instance[index.INITIALIZED])
                    return instance;
                const deferred$1 = new deferred.Deferred();
                instance[index.INITIALIZED] = deferred$1.promise;
                initializer.readyMap.set(instance, deferred$1.promise);
                Promise.resolve((_a = target[index.INITIALIZER]) === null || _a === void 0 ? void 0 : _a.call(target, instance))
                    .then(() => deferred$1.resolve())
                    .catch(deferred$1.reject);
                if (target[index.DESTRUCTOR])
                    destructors.destructors.set(target, target[index.DESTRUCTOR]);
                return instance;
            },
        };
        _injectablesHolder._injectablesHolder.injectService(target, target, false);
        if (injectableToken)
            _injectablesHolder._injectablesHolder.injectService(injectableToken, target, false);
    };
}

exports.Service = Service;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjpudWxsLCJzb3VyY2VzIjpbbnVsbF0sInNvdXJjZXNDb250ZW50IjpbbnVsbF0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUNBQWlDLHFDQUFvQztBQUNyRSwwQkFBMEIsNkJBQTRCO0FBQ3RELG9CQUFvQixzQkFBcUI7QUFDekMsdUJBQXVCLHVCQUFzQjtBQUM3QywwQkFBMEIsbUJBQWtCO0FBQzVDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOyJ9
