/**
 * @license
 * Copyright Andrey Chalkin <L2jLiga@gmail.com> (https://github.com/L2jLiga). All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://github.com/L2jLiga/fastify-decorators/blob/master/LICENSE
 */
import { ControllerType } from '../../registry/controller-type.js';
import { ERROR_HANDLERS, HANDLERS, HOOKS } from '../../symbols/index.js';
import { hasErrorHandlers, hasHandlers, hasHooks } from '../helpers/class-properties.js';
import { createErrorsHandler } from '../helpers/create-errors-handler.js';
import { injectTagsIntoSwagger } from '../helpers/swagger-helper.js';
function targetFactory(constructor, classLoader) {
    return function getTarget(request) {
        return classLoader(constructor, request);
    };
}
/**
 * Various strategies which can be applied to controller
 *
 * @usageNotes
 *
 * There are few available strategies:
 *   SINGLETON strategy creates one instance of controller which will handle all requests
 *   REQUEST strategy will create new instance for each request/hook
 *
 * By default controllers use SINGLETON strategy
 */
export const ControllerTypeStrategies = {
    [ControllerType.SINGLETON](instance, constructor, classLoader, tags) {
        if (tags.length > 0)
            injectTagsIntoSwagger(instance, tags);
        const controllerInstance = classLoader(constructor);
        if (hasHandlers(constructor))
            registerHandlers(constructor[HANDLERS], instance, controllerInstance, tags);
        if (hasErrorHandlers(constructor))
            registerErrorHandlers(constructor[ERROR_HANDLERS], instance, controllerInstance);
        if (hasHooks(constructor))
            registerHooks(constructor[HOOKS], instance, controllerInstance);
        return controllerInstance;
    },
    [ControllerType.REQUEST](instance, constructor, classLoader, tags) {
        if (tags.length > 0)
            injectTagsIntoSwagger(instance, tags);
        const getTarget = targetFactory(constructor, classLoader);
        if (hasHandlers(constructor))
            for (const handler of constructor[HANDLERS]) {
                const { url, method, handlerMethod, options } = handler;
                instance[method](url, tags.length > 0 ? { ...options, schema: { tags: tags.map((tag) => tag.name), ...options.schema } } : options, function (request, ...args) {
                    return getTarget(request)[handlerMethod](request, ...args);
                });
            }
        if (hasErrorHandlers(constructor))
            instance.setErrorHandler((error, request, ...rest) => {
                const errorsHandler = createErrorsHandler(constructor[ERROR_HANDLERS], getTarget(request));
                return errorsHandler(error, request, ...rest);
            });
        if (hasHooks(constructor))
            for (const hook of constructor[HOOKS]) {
                instance.addHook(hook.name, (request, ...rest) => {
                    return getTarget(request)[hook.handlerName](request, ...rest);
                });
            }
    },
};
function registerHandlers(handlers, instance, controllerInstance, tags) {
    for (const handler of handlers) {
        instance[handler.method](handler.url, tags.length > 0 ? { ...handler.options, schema: { tags: tags.map((it) => it.name), ...handler.options.schema } } : handler.options, (...args) => controllerInstance[handler.handlerMethod](...args));
    }
}
function registerHooks(hooks, instance, controllerInstance) {
    for (const hook of hooks) {
        instance.addHook(hook.name, controllerInstance[hook.handlerName].bind(controllerInstance));
    }
}
function registerErrorHandlers(errorHandlers, instance, classInstance) {
    instance.setErrorHandler(createErrorsHandler(errorHandlers, classInstance));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbGxlci10eXBlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vbGliL2RlY29yYXRvcnMvc3RyYXRlZ2llcy9jb250cm9sbGVyLXR5cGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBS0gsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ25FLE9BQU8sRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDekYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDMUUsT0FBTyxFQUFFLHFCQUFxQixFQUFhLE1BQU0sOEJBQThCLENBQUM7QUFFaEYsU0FBUyxhQUFhLENBQUMsV0FBaUMsRUFBRSxXQUF3QjtJQUNoRixPQUFPLFNBQVMsU0FBUyxDQUFDLE9BQXVCO1FBQy9DLE9BQU8sV0FBVyxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUMzQyxDQUFDLENBQUM7QUFDSixDQUFDO0FBSUQ7Ozs7Ozs7Ozs7R0FVRztBQUNILE1BQU0sQ0FBQyxNQUFNLHdCQUF3QixHQUE4QztJQUNqRixDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxJQUFJO1FBQ2pFLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDO1lBQUUscUJBQXFCLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTNELE1BQU0sa0JBQWtCLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRXBELElBQUksV0FBVyxDQUFDLFdBQVcsQ0FBQztZQUFFLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsRUFBRSxRQUFRLEVBQUUs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T0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQW1CLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFDbkosQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLGFBQXVCLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUMxRSxDQUFDO0tBQ0g7QUFDSCxDQUFDO0FBRUQsU0FBUyxhQUFhLENBQ3BCLEtBQXNCLEVBQ3RCLFFBQXlCLEVBQ3pCLGtCQUEwRjtJQUUxRixLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRTtRQUN4QixRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFtQixFQUFFLGtCQUFrQixDQUFDLElBQUksQ0FBQyxXQUFxQixDQUFDLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztLQUNySDtBQUNILENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUM1QixhQUFzQyxFQUN0QyxRQUF5QixFQUN6QixhQUFtRztJQUVuRyxRQUFRLENBQUMsZUFBZSxDQUFDLG1CQUFtQixDQUFDLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDO0FBQzlFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgQW5kcmV5IENoYWxraW4gPEwyakxpZ2FAZ21haWwuY29tPiAoaHR0cHM6Ly9naXRodWIuY29tL0wyakxpZ2EpLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9MMmpMaWdhL2Zhc3RpZnktZGVjb3JhdG9ycy9ibG9iL21hc3Rlci9MSUNFTlNFXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBGYXN0aWZ5SW5zdGFuY2UsIEZhc3RpZnlSZXBseSwgRmFzdGlmeVJlcXVlc3QsIEZhc3RpZnlTY2hlbWEgfSBmcm9tICdmYXN0aWZ5JztcbmltcG9ydCB7IENsYXNzTG9hZGVyIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9ib290c3RyYXAtY29uZmlnLmpzJztcbmltcG9ydCB0eXBlIHsgSUVycm9ySGFuZGxlciwgSUhhbmRsZXIsIElIb29rLCBJbmplY3RhYmxlQ29udHJvbGxlciB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvaW5kZXguanMnO1xuaW1wb3J0IHsgQ29udHJvbGxlclR5cGUgfSBmcm9tICcuLi8uLi9yZWdpc3RyeS9jb250cm9sbGVyLXR5cGUuanMnO1xuaW1wb3J0IHsgRVJST1JfSEFORExFUlMsIEhBTkRMRVJTLCBIT09LUyB9IGZyb20gJy4uLy4uL3N5bWJvbHMvaW5kZXguanMnO1xuaW1wb3J0IHsgaGFzRXJyb3JIYW5kbGVycywgaGFzSGFuZGxlcnMsIGhhc0hvb2tzIH0gZnJvbSAnLi4vaGVscGVycy9jbGFzcy1wcm9wZXJ0aWVzLmpzJztcbmltcG9ydCB7IGNyZWF0ZUVycm9yc0hhbmRsZXIgfSBmcm9tICcuLi9oZWxwZXJzL2NyZWF0ZS1lcnJvcnMtaGFuZGxlci5qcyc7XG5pbXBvcnQgeyBpbmplY3RUYWdzSW50b1N3YWdnZXIsIFRhZ09iamVjdCB9IGZyb20gJy4uL2hlbHBlcnMvc3dhZ2dlci1oZWxwZXIuanMnO1xuXG5mdW5jdGlvbiB0YXJnZXRGYWN0b3J5KGNvbnN0cnVjdG9yOiBJbmplY3RhYmxlQ29udHJvbGxlciwgY2xhc3NMb2FkZXI6IENsYXNzTG9hZGVyKSB7XG4gIHJldHVybiBmdW5jdGlvbiBnZXRUYXJnZXQocmVxdWVzdDogRmFzdGlmeVJlcXVlc3QpIHtcbiAgICByZXR1cm4gY2xhc3NMb2FkZXIoY29uc3RydWN0b3IsIHJlcXVlc3QpO1xuICB9O1xufVxuXG50eXBlIENvbnRyb2xsZXJGYWN0b3J5ID0gKGluc3RhbmNlOiBGYXN0aWZ5SW5zdGFuY2UsIGNvbnN0cnVjdG9yOiBJbmplY3RhYmxlQ29udHJvbGxlciwgY2xhc3NMb2FkZXI6IENsYXNzTG9hZGVyLCB0YWdzOiBUYWdPYmplY3RbXSkgPT4gdW5rbm93bjtcblxuLyoqXG4gKiBWYXJpb3VzIHN0cmF0ZWdpZXMgd2hpY2ggY2FuIGJlIGFwcGxpZWQgdG8gY29udHJvbGxlclxuICpcbiAqIEB1c2FnZU5vdGVzXG4gKlxuICogVGhlcmUgYXJlIGZldyBhdmFpbGFibGUgc3RyYXRlZ2llczpcbiAqICAgU0lOR0xFVE9OIHN0cmF0ZWd5IGNyZWF0ZXMgb25lIGluc3RhbmNlIG9mIGNvbnRyb2xsZXIgd2hpY2ggd2lsbCBoYW5kbGUgYWxsIHJlcXVlc3RzXG4gKiAgIFJFUVVFU1Qgc3RyYXRlZ3kgd2lsbCBjcmVhdGUgbmV3IGluc3RhbmNlIGZvciBlYWNoIHJlcXVlc3QvaG9va1xuICpcbiAqIEJ5IGRlZmF1bHQgY29udHJvbGxlcnMgdXNlIFNJTkdMRVRPTiBzdHJhdGVneVxuICovXG5leHBvcnQgY29uc3QgQ29udHJvbGxlclR5cGVTdHJhdGVnaWVzOiBSZWNvcmQ8Q29udHJvbGxlclR5cGUsIENvbnRyb2xsZXJGYWN0b3J5PiA9IHtcbiAgW0NvbnRyb2xsZXJUeXBlLlNJTkdMRVRPTl0oaW5zdGFuY2UsIGNvbnN0cnVjdG9yLCBjbGFzc0xvYWRlciwgdGFncykge1xuICAgIGlmICh0YWdzLmxlbmd0aCA+IDApIGluamVjdFRhZ3NJbnRvU3dhZ2dlcihpbnN0YW5jZSwgdGFncyk7XG5cbiAgICBjb25zdCBjb250cm9sbGVySW5zdGFuY2UgPSBjbGFzc0xvYWRlcihjb25zdHJ1Y3Rvcik7XG5cbiAgICBpZiAoaGFzSGFuZGxlcnMoY29uc3RydWN0b3IpKSByZWdpc3RlckhhbmRsZXJzKGNvbnN0cnVjdG9yW0hBTkRMRVJTXSwgaW5zdGFuY2UsIGNvbnRyb2xsZXJJbnN0YW5jZSwgdGFncyk7XG4gICAgaWYgKGhhc0Vycm9ySGFuZGxlcnMoY29uc3RydWN0b3IpKSByZWdpc3RlckVycm9ySGFuZGxlcnMoY29uc3RydWN0b3JbRVJST1JfSEFORExFUlNdLCBpbnN0YW5jZSwgY29udHJvbGxlckluc3RhbmNlKTtcbiAgICBpZiAoaGFzSG9va3MoY29uc3RydWN0b3IpKSByZWdpc3Rlckhvb2tzKGNvbnN0cnVjdG9yW0hPT0tTXSwgaW5zdGFuY2UsIGNvbnRyb2xsZXJJbnN0YW5jZSk7XG5cbiAgICByZXR1cm4gY29udHJvbGxlckluc3RhbmNlO1xuICB9LFxuXG4gIFtDb250cm9sbGVyVHlwZS5SRVFVRVNUXShpbnN0YW5jZSwgY29uc3RydWN0b3IsIGNsYXNzTG9hZGVyLCB0YWdzKSB7XG4gICAgaWYgKHRhZ3MubGVuZ3RoID4gMCkgaW5qZWN0VGFnc0ludG9Td2FnZ2VyKGluc3RhbmNlLCB0YWdzKTtcblxuICAgIGNvbnN0IGdldFRhcmdldCA9IHRhcmdldEZhY3RvcnkoY29uc3RydWN0b3IsIGNsYXNzTG9hZGVyKTtcblxuICAgIGlmIChoYXNIYW5kbGVycyhjb25zdHJ1Y3RvcikpXG4gICAgICBmb3IgKGNvbnN0IGhhbmRsZXIgb2YgY29uc3RydWN0b3JbSEFORExFUlNdKSB7XG4gICAgICAgIGNvbnN0IHsgdXJsLCBtZXRob2QsIGhhbmRsZXJNZXRob2QsIG9wdGlvbnMgfSA9IGhhbmRsZXI7XG5cbiAgICAgICAgaW5zdGFuY2VbbWV0aG9kXShcbiAgICAgICAgICB1cmwsXG4gICAgICAgICAgdGFncy5sZW5ndGggPiAwID8geyAuLi5vcHRpb25zLCBzY2hlbWE6IHsgdGFnczogdGFncy5tYXAoKHRhZykgPT4gdGFnLm5hbWUpLCAuLi5vcHRpb25zLnNjaGVtYSB9IGFzIEZhc3RpZnlTY2hlbWEgfSA6IG9wdGlvbnMsXG4gICAgICAgICAgZnVuY3Rpb24gKHJlcXVlc3QsIC4uLmFyZ3MpIHtcbiAgICAgICAgICAgIHJldHVybiBnZXRUYXJnZXQocmVxdWVzdClbaGFuZGxlck1ldGhvZF0ocmVxdWVzdCwgLi4uYXJncyk7XG4gICAgICAgICAgfSxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgIGlmIChoYXNFcnJvckhhbmRsZXJzKGNvbnN0cnVjdG9yKSlcbiAgICAgIGluc3RhbmNlLnNldEVycm9ySGFuZGxlcigoZXJyb3IsIHJlcXVlc3QsIC4uLnJlc3QpID0+IHtcbiAgICAgICAgY29uc3QgZXJyb3JzSGFuZGxlciA9IGNyZWF0ZUVycm9yc0hhbmRsZXIoY29uc3RydWN0b3JbRVJST1JfSEFORExFUlNdLCBnZXRUYXJnZXQocmVxdWVzdCkpO1xuXG4gICAgICAgIHJldHVybiBlcnJvcnNIYW5kbGVyKGVycm9yLCByZXF1ZXN0LCAuLi5yZXN0KTtcbiAgICAgIH0pO1xuXG4gICAgaWYgKGhhc0hvb2tzKGNvbnN0cnVjdG9yKSlcbiAgICAgIGZvciAoY29uc3QgaG9vayBvZiBjb25zdHJ1Y3RvcltIT09LU10pIHtcbiAgICAgICAgaW5zdGFuY2UuYWRkSG9vayhob29rLm5hbWUgYXMgJ29uUmVxdWVzdCcsIChyZXF1ZXN0OiBGYXN0aWZ5UmVxdWVzdCwgLi4ucmVzdDogdW5rbm93bltdKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGdldFRhcmdldChyZXF1ZXN0KVtob29rLmhhbmRsZXJOYW1lXShyZXF1ZXN0LCAuLi5yZXN0KTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gIH0sXG59O1xuXG5mdW5jdGlvbiByZWdpc3RlckhhbmRsZXJzKFxuICBoYW5kbGVyczogSXRlcmFibGU8SUhhbmRsZXI+LFxuICBpbnN0YW5jZTogRmFzdGlmeUluc3RhbmNlLFxuICBjb250cm9sbGVySW5zdGFuY2U6IFJlY29yZDxzdHJpbmcsIChyZXF1ZXN0OiBGYXN0aWZ5UmVxdWVzdCwgcmVwbHk6IEZhc3RpZnlSZXBseSkgPT4gdm9pZD4sXG4gIHRhZ3M6IFRhZ09iamVjdFtdLFxuKTogdm9pZCB7XG4gIGZvciAoY29uc3QgaGFuZGxlciBvZiBoYW5kbGVycykge1xuICAgIGluc3RhbmNlW2hhbmRsZXIubWV0aG9kXShcbiAgICAgIGhhbmRsZXIudXJsLFxuICAgICAgdGFncy5sZW5ndGggPiAwID8geyAuLi5oYW5kbGVyLm9wdGlvbnMsIHNjaGVtYTogeyB0YWdzOiB0YWdzLm1hcCgoaXQpID0+IGl0Lm5hbWUpLCAuLi5oYW5kbGVyLm9wdGlvbnMuc2NoZW1hIH0gYXMgRmFzdGlmeVNjaGVtYSB9IDogaGFuZGxlci5vcHRpb25zLFxuICAgICAgKC4uLmFyZ3MpID0+IGNvbnRyb2xsZXJJbnN0YW5jZVtoYW5kbGVyLmhhbmRsZXJNZXRob2QgYXMgc3RyaW5nXSguLi5hcmdzKSxcbiAgICApO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlZ2lzdGVySG9va3MoXG4gIGhvb2tzOiBJdGVyYWJsZTxJSG9vaz4sXG4gIGluc3RhbmNlOiBGYXN0aWZ5SW5zdGFuY2UsXG4gIGNvbnRyb2xsZXJJbnN0YW5jZTogUmVjb3JkPHN0cmluZywgKHJlcXVlc3Q6IEZhc3RpZnlSZXF1ZXN0LCByZXBseTogRmFzdGlmeVJlcGx5KSA9PiB2b2lkPixcbik6IHZvaWQge1xuICBmb3IgKGNvbnN0IGhvb2sgb2YgaG9va3MpIHtcbiAgICBpbnN0YW5jZS5hZGRIb29rKGhvb2submFtZSBhcyAnb25SZXF1ZXN0JywgY29udHJvbGxlckluc3RhbmNlW2hvb2suaGFuZGxlck5hbWUgYXMgc3RyaW5nXS5iaW5kKGNvbnRyb2xsZXJJbnN0YW5jZSkpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlZ2lzdGVyRXJyb3JIYW5kbGVycyhcbiAgZXJyb3JIYW5kbGVyczogSXRlcmFibGU8SUVycm9ySGFuZGxlcj4sXG4gIGluc3RhbmNlOiBGYXN0aWZ5SW5zdGFuY2UsXG4gIGNsYXNzSW5zdGFuY2U6IFJlY29yZDxzdHJpbmcsIChlcnJvcjogRXJyb3IsIHJlcXVlc3Q6IEZhc3RpZnlSZXF1ZXN0LCByZXBseTogRmFzdGlmeVJlcGx5KSA9PiB2b2lkPixcbikge1xuICBpbnN0YW5jZS5zZXRFcnJvckhhbmRsZXIoY3JlYXRlRXJyb3JzSGFuZGxlcihlcnJvckhhbmRsZXJzLCBjbGFzc0luc3RhbmNlKSk7XG59XG4iXX0=